# Temporal 耐久性実行 検証レポート

## 概要

本レポートは、耐久性実行評価基準（ExoFlow OSDI'23、Flux OSDI'23、Temporal 4プロパティ、Restate、NIST AI RMF、OTel Semantic Conventions）に基づき、Temporal（Python SDK）の本番環境適用可否を評価した結果をまとめたものです。

## テスト環境

- Python: 3.13
- Temporal SDK: 1.22.0
- Temporal Server: 1.29.1（開発モード）
- OS: macOS (Darwin)

---

## 星評価基準

| 星 | ラベル | 定義 | 判定基準 |
|-------|-------|------------|-------------------|
| ⭐ | 未対応 | 機能なし、または動作しない | ドキュメントなし、動作しない、完全な独自実装が必要 |
| ⭐⭐ | 実験的 | 動作するが重大な制約あり、PoCでも苦戦 | 動作するが落とし穴多数、ドキュメント不足、不安定なAPI |
| ⭐⭐⭐ | PoC可能 | 基本機能OK、デモには使えるが本番には追加作業必要 | 主要ケースは動作、エッジケースに弱い、監視・ログはカスタム |
| ⭐⭐⭐⭐ | 本番対応 | 実用的、軽微なカスタマイズで本番デプロイ可能 | 安定、ドキュメント充実、本番事例あり |
| ⭐⭐⭐⭐⭐ | 本番推奨 | そのまま本番で使用可能、ベストプラクティス確立 | 大規模本番事例あり、成熟したエコシステム |

---

## 前提パラメータ

| パラメータ | 値 |
|-----------|-------|
| 実行時間 | 分〜時間 |
| 副作用 | 制限付き書き込み |
| デプロイ | セルフホスト（開発モード） |
| スケール | 〜100 |
| 決定性 | LLM判断を含む |
| 言語 | Python |

---

## カテゴリ別評価サマリー

### カバレッジサマリー（58項目）

| カテゴリ | 項目数 | 良好 (⭐⭐⭐+) | 不十分 (⭐⭐-) | 備考 |
|----------|-------|---------------|-----------------|-------|
| EX: 実行セマンティクス | 7 | 7 | 0 | Event Sourcing + Replay 優秀 |
| RT: リトライ＆タイムアウト | 4 | 4 | 0 | タイムアウト/リトライ完全対応 |
| WF: ワークフロープリミティブ | 6 | 6 | 0 | 全ワークフロー構成要素対応 |
| SG: シグナル＆イベント | 4 | 4 | 0 | シグナル/クエリ/待機 包括的 |
| VR: バージョニング＆マイグレーション | 4 | 4 | 0 | Build IDバージョニング 優秀 |
| CP: 補償＆復旧 | 4 | 4 | 0 | Sagaパターン対応 |
| PF: パフォーマンス＆オーバーヘッド | 3 | 3 | 0 | 妥当なオーバーヘッド |
| OP: 運用 | 7 | 7 | 0 | 完全な管理API |
| OB: 可観測性 | 6 | 6 | 0 | UI + メトリクス + OTel |
| DX: 開発者体験 | 7 | 6 | 1 | 決定性の学習曲線あり |
| AI: AI/エージェント統合 | 6 | 5 | 1 | LLM Activityパターン動作、ストリーミング制限あり |
| **合計** | **58** | **56** | **2** | |

### フェイルクローズ項目ステータス

| 項目 | 評価 | 影響 | 適用条件 |
|------|--------|--------|------------|
| EX-01 進行保証 | ⭐⭐⭐⭐⭐ | **合格** - Event Sourcing + Replay | 常に必須 |
| EX-03 冪等性 / 重複排除 | ⭐⭐⭐⭐⭐ | **合格** - Workflow ID重複排除 | 常に必須 |
| RT-01 リトライ戦略 | ⭐⭐⭐⭐⭐ | **合格** - 完全なRetryPolicy | 常に必須 |
| VR-01 ワークフローバージョニング | ⭐⭐⭐⭐⭐ | **合格** - Build IDバージョニング | 実行時間 >= 分 |
| OP-02 ワークフロー管理API | ⭐⭐⭐⭐⭐ | **合格** - Start/Cancel/Terminate/Query/Signal | 常に必須 |

> **フェイルクローズルール**: 全てのフェイルクローズ項目が合格。総合評価の上限なし。

---

## 良好項目（評価 ⭐⭐⭐ 以上）

| カテゴリ | ID | 項目 | 評価 | 備考 |
|----------|-----|------|--------|-------|
| 実行セマンティクス | EX-01 | 進行保証 | ⭐⭐⭐⭐⭐ | Event Sourcing + Replayがクラッシュ後の進行を保証 |
| 実行セマンティクス | EX-02 | 副作用保証 | ⭐⭐⭐⭐ | Activity結果がメモ化、外部冪等性はユーザー責任 |
| 実行セマンティクス | EX-03 | 冪等性 / 重複排除 | ⭐⭐⭐⭐⭐ | Workflow ID重複排除、Activity idempotency_keyオプション |
| 実行セマンティクス | EX-04 | 状態永続化 | ⭐⭐⭐⭐⭐ | Event Sourcing - 全イベント記録 |
| 実行セマンティクス | EX-05 | 決定性制約 | ⭐⭐⭐⭐ | workflow.* APIで決定論的操作 |
| 実行セマンティクス | EX-06 | 決定性違反ハンドリング | ⭐⭐⭐⭐⭐ | リプレイ不一致時にNonDeterministicWorkflowError |
| 実行セマンティクス | EX-07 | リプレイ精度 | ⭐⭐⭐⭐⭐ | 厳密なEvent Sourcingリプレイ |
| リトライ＆タイムアウト | RT-01 | リトライ戦略 | ⭐⭐⭐⭐⭐ | 指数バックオフ、ジッター、非リトライ型 |
| リトライ＆タイムアウト | RT-02 | タイムアウトシステム | ⭐⭐⭐⭐⭐ | 4種のタイムアウト（schedule-to-close、start-to-close等） |
| リトライ＆タイムアウト | RT-03 | サーキットブレーカー | ⭐⭐⭐ | ネイティブ無、ただしmax_attempts + non_retryableで実現可能 |
| リトライ＆タイムアウト | RT-04 | ハートビート | ⭐⭐⭐⭐⭐ | activity.heartbeat() + 詳細情報、タイムアウト検出 |
| ワークフロープリミティブ | WF-01 | ステップ定義 | ⭐⭐⭐⭐⭐ | @activity.defn、通常 + ローカルActivity |
| ワークフロープリミティブ | WF-02 | 子ワークフロー | ⭐⭐⭐⭐⭐ | execute_child_workflow()、親クローズポリシー |
| ワークフロープリミティブ | WF-03 | 並列実行 / ファンアウト | ⭐⭐⭐⭐⭐ | asyncio.gather()で自然な並列実行 |
| ワークフロープリミティブ | WF-04 | 条件分岐 / ループ | ⭐⭐⭐⭐⭐ | 標準Pythonの制御フロー |
| ワークフロープリミティブ | WF-05 | スリープ / タイマー | ⭐⭐⭐⭐⭐ | 耐久性スリープ、Cronスケジュール |
| ワークフロープリミティブ | WF-06 | キュー / レート制御 | ⭐⭐⭐⭐ | タスクキュー、レート制限（プライオリティキューはカスタム） |
| シグナル＆イベント | SG-01 | 外部シグナル | ⭐⭐⭐⭐⭐ | @workflow.signal、handle.signal()、耐久性あり |
| シグナル＆イベント | SG-02 | 待機 / Awaitables | ⭐⭐⭐⭐⭐ | workflow.wait_condition()で任意の条件待機 |
| シグナル＆イベント | SG-03 | イベントトリガー | ⭐⭐⭐⭐ | API、Cron、Signal-to-Startネイティブ; Kafkaはカスタム |
| シグナル＆イベント | SG-04 | クエリ | ⭐⭐⭐⭐⭐ | @workflow.queryで同期的状態読み取り |
| バージョニング＆マイグレーション | VR-01 | ワークフローバージョニング | ⭐⭐⭐⭐⭐ | workflow.patched() + Build IDバージョニング |
| バージョニング＆マイグレーション | VR-02 | 破壊的変更検出 | ⭐⭐⭐⭐ | リプレイテスト、NonDeterministicWorkflowError |
| バージョニング＆マイグレーション | VR-03 | マイグレーション戦略 | ⭐⭐⭐⭐⭐ | Build IDルーティング、自動ドレイン |
| バージョニング＆マイグレーション | VR-04 | スキーマ進化 | ⭐⭐⭐⭐ | dict.get()、Pydanticデフォルト、Payload Converter |
| 補償＆復旧 | CP-01 | 補償 / Saga | ⭐⭐⭐⭐ | try/except + 補償パターン |
| 補償＆復旧 | CP-02 | 部分再開 | ⭐⭐⭐⭐⭐ | Activity結果がメモ化、ワークフローリセット |
| 補償＆復旧 | CP-03 | 手動介入 | ⭐⭐⭐⭐⭐ | UI + CLI + APIでTerminate/Cancel/Reset/Signal |
| 補償＆復旧 | CP-04 | デッドレター | ⭐⭐⭐⭐ | max_attempts、UIで失敗ステータス確認可能 |
| パフォーマンス＆オーバーヘッド | PF-01 | ステップレイテンシ | ⭐⭐⭐⭐ | 通常〜4ms、ローカルActivity〜0.2ms |
| パフォーマンス＆オーバーヘッド | PF-02 | ファンアウトスループット | ⭐⭐⭐⭐ | 〜25タスク/秒（設定依存） |
| パフォーマンス＆オーバーヘッド | PF-03 | ペイロードサイズ制限 | ⭐⭐⭐⭐ | デフォルト2MB、Payload Codecで圧縮可能 |
| 運用 | OP-01 | デプロイモデル | ⭐⭐⭐⭐⭐ | セルフホスト + Temporal Cloud |
| 運用 | OP-02 | ワークフロー管理API | ⭐⭐⭐⭐⭐ | Start/Cancel/Terminate/Query/Signal/Describe/List |
| 運用 | OP-03 | ストレージバックエンド | ⭐⭐⭐⭐⭐ | PostgreSQL/MySQL/Cassandra、Elasticsearch（可視性用） |
| 運用 | OP-04 | スケーラビリティ | ⭐⭐⭐⭐⭐ | ワーカー水平スケーリング、4サービスアーキテクチャ |
| 運用 | OP-05 | データ保持 / クリーンアップ | ⭐⭐⭐⭐⭐ | 名前空間保持、S3へのアーカイブ |
| 運用 | OP-06 | マルチリージョン / HA | ⭐⭐⭐⭐ | サービスレプリケーション、Temporal Cloudマルチリージョン |
| 運用 | OP-07 | マルチテナント分離 | ⭐⭐⭐⭐ | 名前空間分離、Cloudリソースクォータ |
| 可観測性 | OB-01 | ダッシュボード / UI | ⭐⭐⭐⭐⭐ | 完全なワークフロー管理機能付きTemporal Web UI |
| 可観測性 | OB-02 | メトリクス | ⭐⭐⭐⭐⭐ | Prometheus形式、包括的なメトリクス |
| 可観測性 | OB-03 | 履歴可視化 | ⭐⭐⭐⭐⭐ | UI/CLIで完全なイベント履歴 |
| 可観測性 | OB-04 | OTel準拠 | ⭐⭐⭐⭐ | contrib.opentelemetry、TracingInterceptor |
| 可観測性 | OB-05 | アラート | ⭐⭐⭐⭐ | Prometheus + AlertManager、Cloud組み込み |
| 可観測性 | OB-06 | ロギング | ⭐⭐⭐⭐ | workflow.logger（Workflow ID相関付き） |
| 開発者体験 | DX-01 | SDK設計 | ⭐⭐⭐⭐⭐ | デコレータベース、async/await、型ヒント |
| 開発者体験 | DX-02 | 言語サポート | ⭐⭐⭐⭐⭐ | Go/Java/TypeScript/Python/.NET公式SDK |
| 開発者体験 | DX-03 | ローカル開発 | ⭐⭐⭐⭐⭐ | temporal server start-dev、単一コマンド |
| 開発者体験 | DX-04 | テスト / タイムスキップ | ⭐⭐⭐⭐⭐ | WorkflowEnvironment、タイムスキップ、リプレイテスト |
| 開発者体験 | DX-05 | エラーメッセージ / デバッグ | ⭐⭐⭐⭐ | 完全なスタックトレース、UIでのエラー表示 |
| 開発者体験 | DX-07 | ローカルリプレイハーネス | ⭐⭐⭐⭐⭐ | 本番履歴リプレイ用WorkflowReplayer |
| AI/エージェント統合 | AI-01 | ActivityとしてのLLM呼び出し | ⭐⭐⭐⭐⭐ | LLM呼び出しをActivityとして実行、結果がメモ化 |
| AI/エージェント統合 | AI-02 | 非決定性ハンドリング | ⭐⭐⭐⭐ | Activity分離、プロンプト/モデル変更管理はカスタム |
| AI/エージェント統合 | AI-03 | HITL / 人間承認 | ⭐⭐⭐⭐⭐ | Signal + wait_condition、耐久性のある承認待機 |
| AI/エージェント統合 | AI-05 | エージェントフレームワーク統合 | ⭐⭐⭐⭐ | LangGraph/CrewAI/OpenAI SDKパターン文書化 |
| AI/エージェント統合 | AI-06 | ツール実行耐障害性 | ⭐⭐⭐⭐⭐ | ツールごとのリトライポリシー、タイムアウト、ハートビート |

---

## 不十分項目（評価 ⭐⭐ 以下）

| カテゴリ | ID | 項目 | 評価 | 備考 | 検証スクリプト |
|----------|-----|------|--------|-------|---------------------|
| 開発者体験 | DX-06 | 学習曲線 | ⭐⭐⭐ | 決定性制約の理解が必要 | 10_dx_developer_experience.py |
| AI/エージェント統合 | AI-04 | ストリーミング | ⭐⭐⭐ | ワークフロー境界を越えたストリーミング不可 | 11_ai_agent_integration.py |

> 注: 両項目とも⭐⭐⭐（PoC可能）評価、⭐⭐以下の項目なし。

---

## 検証スクリプト

| スクリプト | カテゴリ | 主要検証項目 |
|--------|------------|------------------------|
| 01_ex_execution_semantics.py | 実行セマンティクス | EX-01〜EX-07: 進行、冪等性、リプレイ |
| 02_rt_retry_timeout.py | リトライ＆タイムアウト | RT-01〜RT-04: リトライ、タイムアウト、ハートビート |
| 03_wf_workflow_primitives.py | ワークフロープリミティブ | WF-01〜WF-06: ステップ、子WF、並列、スリープ |
| 04_sg_signals_events.py | シグナル＆イベント | SG-01〜SG-04: シグナル、待機、クエリ |
| 05_vr_versioning.py | バージョニング＆マイグレーション | VR-01〜VR-04: バージョニング、マイグレーション |
| 06_cp_compensation.py | 補償＆復旧 | CP-01〜CP-04: Saga、再開、介入 |
| 07_pf_performance.py | パフォーマンス＆オーバーヘッド | PF-01〜PF-03: レイテンシ、スループット、ペイロード |
| 08_op_operations.py | 運用 | OP-01〜OP-07: デプロイ、管理、スケール |
| 09_ob_observability.py | 可観測性 | OB-01〜OB-06: UI、メトリクス、OTel、ロギング |
| 10_dx_developer_experience.py | 開発者体験 | DX-01〜DX-07: SDK、テスト、デバッグ |
| 11_ai_agent_integration.py | AI/エージェント統合 | AI-01〜AI-06: LLM、HITL、ツール |

---

## 主要な発見

### 強み（⭐⭐⭐⭐+）

1. **実行セマンティクス**（EX: 平均 ⭐⭐⭐⭐⭐）
   - Event Sourcingが強力な進行保証とリプレイ保証を提供
   - Activity結果がメモ化され、コスト効率の良いリプレイ
   - 明確なエラーメッセージによる決定性違反検出

2. **運用**（OP: 平均 ⭐⭐⭐⭐⭐）
   - 包括的な管理API（Start/Cancel/Terminate/Query/Signal）
   - 複数のストレージバックエンド（Postgres/MySQL/Cassandra）
   - マネージドデプロイ用Temporal Cloud

3. **開発者体験**（DX: 平均 ⭐⭐⭐⭐⭐）
   - デコレータとasync/awaitによるPythonらしいSDK
   - 長時間ワークフローのテスト用タイムスキップ
   - 単一コマンドのローカル開発サーバー

4. **可観測性**（OB: 平均 ⭐⭐⭐⭐⭐）
   - ワークフロー可視化用Temporal Web UI
   - Prometheusメトリクス組み込み
   - OpenTelemetry統合利用可能

5. **バージョニング**（VR: 平均 ⭐⭐⭐⭐⭐）
   - 自動ドレイン付きBuild IDバージョニング
   - コードレベル互換性のためのworkflow.patched()
   - 破壊的変更検出用リプレイテスト

### 考慮事項

1. **学習曲線**（DX-06: ⭐⭐⭐）
   - 決定性制約の理解が必要
   - Event Sourcingのメンタルモデルが必要
   - ドキュメントは充実しているが概念の習得に時間がかかる

2. **LLMストリーミング**（AI-04: ⭐⭐⭐）
   - ワークフロー境界を越えたストリーミング不可
   - Activity内部でのストリーミングは可能
   - チャンクベースパターンで回避可能

3. **サーキットブレーカー**（RT-03: ⭐⭐⭐）
   - ネイティブのサーキットブレーカーなし
   - max_attempts + non_retryable_typesで実現可能
   - サーバーサイドレート制限は利用可能

---

## LangGraph / CrewAI 比較

| 観点 | Temporal | LangGraph | CrewAI |
|--------|----------|-----------|--------|
| 主要フォーカス | 耐久性実行 | エージェントグラフ | マルチエージェント協調 |
| 耐久性 | ⭐⭐⭐⭐⭐ ネイティブ | ⭐⭐⭐⭐ Checkpointer | ⭐⭐⭐⭐ @persist |
| HITL | ⭐⭐⭐⭐⭐ Signal/Wait | ⭐⭐⭐⭐⭐ interrupt() | ⭐⭐⭐ human_input |
| リプレイ | ⭐⭐⭐⭐⭐ Event Sourcing | ⭐⭐ 部分的 | ⭐ カスタム |
| バージョニング | ⭐⭐⭐⭐⭐ Build ID | ⭐⭐ カスタム | ⭐ カスタム |
| 学習曲線 | ⭐⭐⭐ 概念理解必要 | ⭐⭐⭐ グラフモデル | ⭐⭐⭐⭐ 高抽象度 |
| LLMネイティブ | ⭐⭐⭐ Activityパターン | ⭐⭐⭐⭐⭐ ネイティブ | ⭐⭐⭐⭐⭐ ネイティブ |

### Temporalを使うべき場面

- 長時間ワークフロー（時間/日/月単位）
- 強い耐久性要件
- 複雑なリトライ/タイムアウト要件
- 本番グレードのバージョニングが必要
- マルチ言語ワークフロー

### LangGraph/CrewAIを使うべき場面

- 迅速なLLMファーストプロトタイピング
- シンプルな会話フロー
- 長時間状態保持不要
- エージェント協調パターン（CrewAI）
- グラフベース推論（LangGraph）

### 組み合わせアプローチ

本番AIシステムにはTemporal + LangGraph/CrewAIを推奨：
- **Temporal** で耐久性オーケストレーション、リトライ、永続化
- **LangGraph/CrewAI** でActivity内のエージェントロジック
- Activityラッピングによりlm呼び出しの耐久性を確保

---

## 推奨事項

### 本番デプロイチェックリスト

本番デプロイ時に確認すべき項目：

1. **インフラ**
   - [ ] PostgreSQL/MySQL（永続化用）
   - [ ] Elasticsearch（可視性・検索用）
   - [ ] マルチレプリカサーバーデプロイ
   - [ ] ワーカー水平スケーリング

2. **監視**
   - [ ] Prometheusメトリクス収集
   - [ ] 障害アラート用AlertManager
   - [ ] デバッグ用Temporal UIアクセス

3. **開発プラクティス**
   - [ ] CI/CDでのリプレイテスト
   - [ ] 決定性違反検出
   - [ ] デプロイ用ワーカーバージョニング

---

## 結論

### 総合評価: ⭐⭐⭐⭐⭐（本番推奨）

Temporalは全評価基準を包括的にサポートする最も成熟した耐久性実行プラットフォームです：

**強み:**
- Event Sourcingによる最も強力な耐久性保証
- 包括的な管理APIとUI
- 安全なデプロイのためのBuild IDバージョニング
- async/await対応の優れたPython SDK
- 効率的なテストのためのタイムスキップ

**考慮事項:**
- 決定性制約の学習曲線
- サーバーサイドデプロイが必要（組み込みモードなし）
- LLMストリーミングには回避パターンが必要

### 評決

Temporalは以下の用途に**強く推奨**：
- 耐久性を必要とする本番AI/エージェントシステム
- Human-in-the-loopを含む長時間ワークフロー
- 強力なリプレイとバージョニングが必要なシステム

58項目の評価で**56項目が⭐⭐⭐以上**、**全5つのフェイルクローズ項目が合格**。Temporalは本番環境における耐久性実行の基準を確立しています。

---

# ファイル構成

```
temporal-example/
├── 01_ex_execution_semantics.py   # EXカテゴリ検証
├── 02_rt_retry_timeout.py         # RTカテゴリ検証
├── 03_wf_workflow_primitives.py   # WFカテゴリ検証
├── 04_sg_signals_events.py        # SGカテゴリ検証
├── 05_vr_versioning.py            # VRカテゴリ検証
├── 06_cp_compensation.py          # CPカテゴリ検証
├── 07_pf_performance.py           # PFカテゴリ検証
├── 08_op_operations.py            # OPカテゴリ検証
├── 09_ob_observability.py         # OBカテゴリ検証
├── 10_dx_developer_experience.py  # DXカテゴリ検証
├── 11_ai_agent_integration.py     # AIカテゴリ検証
├── common.py                      # 共有ユーティリティ
├── REPORT.md                      # 本レポート（英語）
├── REPORT_ja.md                   # 本レポート（日本語）
├── README.md                      # クイックスタートガイド
├── .env.example                   # 環境変数テンプレート
├── pyproject.toml
└── uv.lock
```
