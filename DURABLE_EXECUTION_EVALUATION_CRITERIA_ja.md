# Durable Execution 評価マスタ

> **設計根拠**
>
> - ExoFlow (OSDI'23): Exactly-once semantics for workflow DAGs
> - Flux (OSDI'23): Automated verification of idempotence
> - Temporal Durable Execution 4特性: (1) 進行の保証 (2) 状態の永続化 (3) 実行の可視化 (4) コードとしてのワークフロー
> - Restate: Journal-based durable execution + durable RPC
> - NIST AI RMF: 障害復旧・監査・来歴
> - OTel Semantic Conventions: 標準観測性

---

## 星評価の基準（全項目共通）

| 星 | ラベル | 定義 | 判定基準 |
|----|--------|------|----------|
| ⭐ | 未対応 | 機能がない、または壊れている | ドキュメントに記載なし、実装しても動かない、完全に自前実装が必要 |
| ⭐⭐ | 実験的 | 動くが制約が大きく、PoCでも苦労する | 動作はするがハマりどころ多い、ドキュメント不足、APIが不安定 |
| ⭐⭐⭐ | PoC可 | 基本動作OK、デモには使えるが本番には追加実装が必要 | 主要ケースは動く、エッジケースに弱い、監視・ログ等は自前 |
| ⭐⭐⭐⭐ | 本番可 | 実用的、多少のカスタマイズで本番投入できる | 安定動作、ドキュメント充実、本番事例あり、軽微なカスタマイズで済む |
| ⭐⭐⭐⭐⭐ | 本番推奨 | そのまま本番で使える、ベストプラクティスが確立 | 大規模本番事例あり、エコシステム成熟、運用ノウハウが蓄積 |

### 判定のポイント

- **⭐⭐⭐ → ⭐⭐⭐⭐ の壁**: 「PoCから本番に持っていく時に何が必要か」が明確かどうか
- **⭐⭐⭐⭐ → ⭐⭐⭐⭐⭐ の壁**: 「自分で考えなくてもベストプラクティスがある」かどうか
- 「機能がそもそもない」は ⭐（Not Goodセクションに分類）
- 「あるけど使い物にならない」は ⭐⭐

### フェイルクローズルール

以下の項目が **⭐⭐ 以下** の場合、他カテゴリの平均が高くても **総合評価の上限は ⭐⭐** とする。

| 必須項目 | 理由 | 適用条件 |
|---------|------|---------|
| EX-01 進行保証 | クラッシュ後にワークフローが進行しないならdurable executionではない | 常に必須 |
| EX-03 冪等 / 重複排除 | リトライで副作用が重複するなら本番で事故になる | 常に必須 |
| RT-01 リトライ戦略 | 障害復旧の基本。これがないなら自前キューの方がマシ | 常に必須 |
| VR-01 ワークフローバージョニング | 長期実行中のコード変更でReplayが壊れたら全Run死亡 | Duration >= 分 |
| OP-02 ワークフロー管理API | 本番で止められない・調べられないワークフローは運用不能 | 常に必須 |

> **前提**: このマスタは Duration が「分以上」のワークフローを対象とする。
> ミリ秒〜秒の短命ジョブ専用ツールでは VR-01 はフェイルクローズではなく加点扱いとする。

> **警告**: DX-03（ローカル開発）が ⭐⭐ 以下の場合、開発効率への影響が極めて大きい。
> デバッグサイクルが「コード修正→デプロイ→実行待ち」となり、実質的な開発速度が1/10以下になりうる。

---

## 前提パラメータ（評価テンプレートの冒頭に記録）

Durable Executionツールの評価は、想定する実行パターンによって結果が変わる。
特に **Language** は同一ツールでもSDKの成熟度が大きく異なるため、必ず記録する。

| パラメータ | 内容 | 例 |
|-----------|------|-----|
| **Duration** | ワークフローの想定実行時間 | ミリ秒〜秒 / 分〜時間 / 日〜月 |
| **Side Effects** | 外部システムへの副作用の強さ | 読み取りのみ / 制限付き書き込み / 金融・課金等の不可逆書き込み |
| **Deployment** | デプロイ形態 | セルフホスト / マネージドクラウド / サーバーレス / ライブラリ組み込み |
| **Scale** | 同時実行ワークフロー数 | 〜100 / 〜10K / 100K+ |
| **Determinism** | 非決定的要素の有無 | 決定論的のみ / LLM・外部API含む |
| **Language** | 評価対象のSDK言語 | Python / Go / Java / TypeScript / .NET 等 |

---

## 評価カテゴリ・項目マスタ

### カテゴリ一覧

| ID | カテゴリ | 責務（一行定義） | 層 |
|----|---------|----------------|-----|
| EX | Execution Semantics | **正しさ**: 進行保証・副作用保証・状態再構築が正しいか | コア |
| RT | Retry & Timeout | **耐障害**: リトライ・タイムアウト・バックプレッシャーが適切か | コア |
| WF | Workflow Primitives | **表現力**: ワークフローの構成要素・制御フローが十分か | 機能 |
| SG | Signals & Events | **反応性**: 外部イベント・シグナル・クエリに応答できるか | 機能 |
| VR | Versioning & Migration | **進化性**: コード変更・スキーマ変更に安全に対応できるか | 安全 |
| CP | Compensation & Recovery | **回復力**: 失敗時に正しく戻せるか・手動介入できるか | 安全 |
| PF | Performance & Overhead | **効率性**: 永続化の代償としてのレイテンシ・スループット・サイズ制約 | 性能 |
| OP | Operations | **運用性**: デプロイ・管理・スケール・保持が実用的か | 運用 |
| OB | Observability | **可視性**: 人間が実行状態を理解・調査・監視できるか | 運用 |
| DX | Developer Experience | **生産性**: 開発・テスト・デバッグが効率的か | 体験 |
| AI | AI/Agent Integration | **拡張性**: LLM/Agent統合・非決定性・HITLに対応できるか | 拡張 |

---

### 項目マスタ（全ツール共通）

#### EX: Execution Semantics

**責務: 正しさ** — 進行保証・副作用保証・状態再構築が正しいか

| ID | 項目 | 評価内容 |
|----|------|---------|
| EX-01 | 進行保証 | クラッシュ・再起動後もワークフローが進行し続ける保証（再実行、履歴、ステップの再スケジュール） |
| EX-02 | 副作用保証 | 外部への書き込みが重複しない/整合するための仕組み（idempotency key / outbox / dedupe hooks がツール側で提供されるか） |
| EX-03 | 冪等 / 重複排除 | Activityレベルでのidempotency key、ワークフローレベルでの重複起動排除 |
| EX-04 | 状態永続化 | ワークフロー状態のチェックポイント方式（Event Sourcing / ステップメモ化 / スナップショット） |
| EX-05 | 決定性制約 | ワークフローコードの決定性要件と、要件の範囲（全コード / Activity外のみ等）。Replay型（Temporal）はコード全体に厳しい決定性制約を課し、Journal/Log型（Restate, Inngest）は制約が緩い傾向がある。アーキテクチャの違いを考慮して評価する |
| EX-06 | 決定性違反ハンドリング | 決定性制約を破った場合の検出・診断（Replay divergence検知、fail-fast、診断ツール） |
| EX-07 | Replay正確性 | 障害後のワークフロー状態再構築が正しいか（Event History replay / checkpointリストアの正確性・互換性） |

#### RT: Retry & Timeout

**責務: 耐障害** — リトライ・タイムアウト・バックプレッシャーが適切か

| ID | 項目 | 評価内容 |
|----|------|---------|
| RT-01 | リトライ戦略 | 固定/指数バックオフ/ジッター、最大試行数、リトライ分類（retryable vs non-retryable） |
| RT-02 | タイムアウト体系 | Start-to-close / Schedule-to-start / Schedule-to-close / Heartbeat の粒度 |
| RT-03 | サーキットブレーカ | 連続失敗時の自動停止、バックプレッシャー制御 |
| RT-04 | Heartbeat | 長時間Activityの生存確認、ハング検知 |

#### WF: Workflow Primitives

**責務: 表現力** — ワークフローの構成要素・制御フローが十分か

| ID | 項目 | 評価内容 |
|----|------|---------|
| WF-01 | ステップ定義 | Activity / Step / Task の定義方法、粒度の柔軟性 |
| WF-02 | 子ワークフロー | ワークフローのネスト・再利用。親終了時の子の挙動ポリシー（Abandon / Terminate / Wait）を制御できるか |
| WF-03 | 並列実行 / Fan-out | 複数ステップの並列実行とFan-in（結果集約） |
| WF-04 | 条件分岐 / ループ | if/else、for/while相当の制御フロー |
| WF-05 | スリープ / タイマー | 長期スリープ（日〜月）、スケジュール実行、Cron |
| WF-06 | キュー / 流量制御 | タスクキュー、concurrency制限、レート制限、優先度 |

#### SG: Signals & Events

**責務: 反応性** — 外部イベント・シグナル・クエリに応答できるか

| ID | 項目 | 評価内容 |
|----|------|---------|
| SG-01 | 外部シグナル | 実行中のワークフローに外部からデータ/指示を送る |
| SG-02 | ウェイト / Awaitables | 外部イベント待ち（Webhookコールバック、人間の承認等） |
| SG-03 | イベントトリガー | イベント駆動でワークフローを起動（Kafka、Webhook等） |
| SG-04 | クエリ | 実行中のワークフローの状態を外部から読み取る |

#### VR: Versioning & Migration

**責務: 進化性** — コード変更・スキーマ変更に安全に対応できるか

| ID | 項目 | 評価内容 |
|----|------|---------|
| VR-01 | ワークフローバージョニング | コード変更時に既存実行を壊さない仕組み（下記の段階基準を参照） |
| VR-02 | 非互換変更の検出 | 破壊的変更を事前に検出できるか（replay test / determinism check）。検出時にfail-fastするか、黙って壊れるか |
| VR-03 | マイグレーション戦略 | 旧バージョン → 新バージョンへの移行手順、drain / cutover |
| VR-04 | スキーマ進化 | ワークフロー入出力のスキーマ変更への耐性 |

**VR-01 採点基準（段階定義）**:

| 星 | 判定基準 |
|----|---------|
| ⭐ | バージョニング機構なし。コード変更で既存実行が壊れる |
| ⭐⭐ | 既存実行を完了まで待つ（drain）か切り捨てるしかない |
| ⭐⭐⭐ | コード内分岐（if version / patching API）で新旧を共存できるが、コードが汚れる |
| ⭐⭐⭐⭐ | Worker / Task Queue単位のルーティングで新旧コードを分離できる。コードを汚さずに旧実行を維持可能 |
| ⭐⭐⭐⭐⭐ | Build IDベースの自動ルーティングがあり、デプロイ時にバージョン対応付けが自動化されている。旧Workerの自動drain/retire機能あり |

#### CP: Compensation & Recovery

**責務: 回復力** — 失敗時に正しく戻せるか・手動介入できるか

| ID | 項目 | 評価内容 |
|----|------|---------|
| CP-01 | 補償トランザクション / サガ | ステップ失敗時の逆操作の定義・自動実行。補償アクション自体が失敗した場合の挙動（リトライ上限、Dead Letter送り、手動介入への昇格）まで定義されているか |
| CP-02 | 部分適用 / 途中再開 | 失敗したステップからの再開（全体やり直しではなく） |
| CP-03 | 手動介入 | ダッシュボード/APIからのワークフロー修正・再開・スキップ |
| CP-04 | Dead Letter / 毒メッセージ | 処理不能なワークフローの隔離と通知 |

#### PF: Performance & Overhead

**責務: 効率性** — 永続化の代償としてのレイテンシ・スループット・サイズ制約

| ID | 項目 | 評価内容 |
|----|------|---------|
| PF-01 | ステップレイテンシ | 空のステップを実行するのにかかるオーバーヘッド。永続化・キュー往復を含むE2Eレイテンシ（通常5ms〜100ms。ミリ秒要件のアプリには致命的） |
| PF-02 | Fan-out スループット | 1ワークフローから大量のActivity（1K〜10K）を並列起動した時のスループット。DBロック競合やキュー詰まりの有無 |
| PF-03 | ペイロードサイズ制限 | ワークフロー入出力・Activity引数/戻り値のサイズ制限。制限超過時のオフロード機構（Claim Check / Blob Storage連携）の有無 |

#### OP: Operations

**責務: 運用性** — デプロイ・管理・スケール・保持が実用的か

| ID | 項目 | 評価内容 |
|----|------|---------|
| OP-01 | デプロイモデル | セルフホスト / マネージドクラウド / ライブラリ組み込み / サーバーレス |
| OP-02 | ワークフロー管理API | Start / Cancel / Terminate / Pause / Resume / List / Describe |
| OP-03 | ストレージバックエンド | 対応DB（Postgres / MySQL / Cassandra / SQLite等）、ストレージ要件 |
| OP-04 | スケーラビリティ | Worker水平スケール、シャーディング、バックプレッシャー |
| OP-05 | データ保持 / クリーンアップ | 実行履歴のTTL、アーカイブ、Purge |
| OP-06 | マルチリージョン / HA | 高可用性構成、リージョン間フェイルオーバー |
| OP-07 | マルチテナント分離 | テナント間のリソース分離、ある顧客の暴走が他に影響しないか |

#### OB: Observability

**責務: 可視性** — 人間が実行状態を理解・調査・監視できるか

| ID | 項目 | 評価内容 |
|----|------|---------|
| OB-01 | ダッシュボード / UI | ワークフロー一覧・状態・履歴の可視化、検索・フィルタリング |
| OB-02 | メトリクス | ワークフロー実行数・成功率・レイテンシ・キュー深度 |
| OB-03 | 実行履歴の可視化 | ステップ単位の入出力閲覧、相関ID、タイムライン表示（EX-07が「再構築の正しさ」、OB-03は「人間が読めるか」） |
| OB-04 | OTel準拠 | OpenTelemetry Semantic Conventionsへの対応 |
| OB-05 | アラート | 失敗率・遅延・キュー溢れの検知と通知 |
| OB-06 | ログ | 構造化ログ、ワークフローIDによるフィルタリング |

#### DX: Developer Experience

**責務: 生産性** — 開発・テスト・デバッグが効率的か

| ID | 項目 | 評価内容 |
|----|------|---------|
| DX-01 | SDK設計 | APIのシンプルさ、言語ネイティブ度（デコレータ / 型ヒント / async-await） |
| DX-02 | 言語サポート | 対応言語の数と各SDKの成熟度。同一ツールでもSDK間の機能格差（Language Parity）を評価 |
| DX-03 | ローカル開発 | ローカルでの実行・デバッグの容易さ（dev server / in-process / Docker compose / シングルバイナリ） |
| DX-04 | テスト / Time Skipping | ワークフローのユニットテスト、モック注入。長期スリープ（sleep 30日等）をテスト内で一瞬で通過させるTime Skipping（仮想時間制御）の有無 |
| DX-05 | エラーメッセージ / デバッグ | エラー時の情報量、スタックトレース、原因特定のしやすさ |
| DX-06 | 学習曲線 | 概念モデルの複雑さ、「普通のコード」からの距離 |
| DX-07 | ローカルReplayハーネス | 本番の実行履歴をローカルに持ってきて再生・デバッグできるか |

#### AI: AI/Agent Integration

**責務: 拡張性** — LLM/Agent統合・非決定性・HITLに対応できるか

| ID | 項目 | 評価内容 |
|----|------|---------|
| AI-01 | LLM呼び出しのActivity化 | LLM APIコールをdurableなActivityとして実行できるか |
| AI-02 | 非決定性の扱い | LLM応答のような非決定的出力のReplay / キャッシュ / 固定（下記の段階基準を参照） |
| AI-03 | HITL / 人間承認 | ワークフロー内での人間の承認待ち（Signal / Wait / Callback） |
| AI-04 | ストリーミング | LLMのストリーミング応答をワークフロー内で扱えるか |
| AI-05 | Agent Framework統合 | LangGraph / CrewAI / OpenAI SDK等との統合例・ドキュメント |
| AI-06 | Tool実行の耐障害性 | 外部ツール呼び出しのリトライ・タイムアウト・フォールバックがDE側で管理されるか |

**AI-02 採点基準（段階定義）**:

| 星 | 判定基準 |
|----|---------|
| ⭐ | LLMの非決定性について言及なし。Replay時にLLMを再実行してしまう |
| ⭐⭐ | キャッシュ例があるが再生保証は弱い（プロンプト/モデル変更で破綻） |
| ⭐⭐⭐ | LLMをActivityとして隔離し、入力/出力を履歴に保存できる。再生時はActivity結果を返す |
| ⭐⭐⭐⭐ | モデルID・温度・seed・プロンプト断面を含む固定が設計され、再生が標準ワークフローに組み込まれている |
| ⭐⭐⭐⭐⭐ | LLM部分だけを差し替えて検証できる（A/B replay / shadow replay）。非決定部分のdiffが取れる |

---

## 項目数サマリ

| カテゴリ | 項目数 |
|---------|--------|
| EX | 7 |
| RT | 4 |
| WF | 6 |
| SG | 4 |
| VR | 4 |
| CP | 4 |
| PF | 3 |
| OP | 7 |
| OB | 6 |
| DX | 7 |
| AI | 6 |
| **合計** | **58** |

---

## 評価テンプレート

### 前提パラメータ

| パラメータ | 値 |
|-----------|-----|
| Duration | |
| Side Effects | |
| Deployment | |
| Scale | |
| Determinism | |
| Language | |

### Good（⭐⭐⭐ 以上）

| カテゴリ | ID | 項目 | Temporal | Restate | Inngest | 備考（Doc / Repro / Evidence） |
|---------|-----|------|---------|---------|---------|-------------------------------|
| EX | EX-01 | 進行保証 | | | | |
| ... | ... | ... | ... | ... | ... | ... |

### Not Good（⭐⭐ 以下）

| カテゴリ | ID | 項目 | Temporal | Restate | Inngest | 備考（Doc / Repro / Evidence） |
|---------|-----|------|---------|---------|---------|-------------------------------|
| ... | ... | ... | ... | ... | ... | ... |

---

## 注記

### 備考の記入ルール

評価の再現性を担保するため、備考には以下を可能な限り含める:

- **Doc**: 該当するドキュメントページ
- **Repro**: 検証に使ったコマンド / スクリプト / リポジトリ
- **Evidence**: スクリーンショット / ログ出力 / テスト結果

### 項目別の段階定義について

一部の項目（VR-01、AI-02）には共通星基準に加えて項目固有の段階定義がある。
これらは「星の意味が項目の性質上ブレやすく、採点者間で解釈が割れる」項目に限定して設けている。
フェイルクローズ項目（EX-01、EX-03、RT-01、VR-01、OP-02）の段階定義は、検証を通じて必要と判断した時点で追加する。

### 重複項目の責務境界

同じ事実が複数カテゴリに関わる場合、以下の責務で採点を分離する:

| 重複しやすい組 | 責務の切り分け |
|--------------|--------------|
| EX-07 Replay正確性 ↔ OB-03 実行履歴の可視化 | EX-07は「再構築が正しいか」、OB-03は「人間が読めるか・検索できるか」 |
| CP-02 途中再開 ↔ OP-02 管理API | CP-02は「失敗ステップからの回復ロジック」、OP-02は「APIとしてのCRUD操作」 |
| RT-04 Heartbeat ↔ RT-02 タイムアウト体系 | RT-02は「タイムアウトの種類と粒度」、RT-04は「長時間Activityの生存確認メカニズム」 |

### ツール固有の項目について

マスタにない項目が検証で発見された場合:
1. まずマスタの既存項目に該当しないか確認
2. 該当しない場合、適切なカテゴリにIDを振って追加
3. 他ツールでも該当する汎用的な項目であること

### 評価の更新ルール

- 検証時点のバージョンを記録する
- 後から再検証した場合は上書きし、変更履歴を残す
- 未検証の項目は「-」（ハイフン）で埋める

### 将来拡張候補

| カテゴリ案 | 内容 | 保留理由 |
|-----------|------|---------|
| SE: Security | mTLS、ペイロード暗号化、ネットワーク境界 | セルフホスト時のインフラ設計の話に寄る |
| CS: Cost | 課金モデル、ステップ単価、ストレージ費用 | 価格体系が頻繁に変わるため、レポート時点の記録に留める |
